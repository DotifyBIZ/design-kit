name: Post Release to Forge Portal

on:
  release:
    types: [published]

jobs:
  post-release:
    runs-on: ubuntu-latest

    steps:
      - name: Post GitHub release to WordPress
        env:
          WP_API_URL: ${{ secrets.WP_API_URL }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
          REPO_NAME: ${{ github.event.repository.name }}
          RELEASE_TITLE: ${{ github.event.release.name || github.event.release.tag_name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          
        run: |
          set -e

          AUTH=$(echo -n "$WP_USERNAME:$WP_APP_PASSWORD" | base64)

          echo "Fetching category ID for: $REPO_NAME"

          CATEGORY_ID=$(curl -s \
            -H "Authorization: Basic $AUTH" \
            "$WP_API_URL/categories?search=$REPO_NAME" | jq '.[0].id')

          if [ "$CATEGORY_ID" = "null" ] || [ -z "$CATEGORY_ID" ]; then
            echo "Category '$REPO_NAME' not found. Aborting."
            exit 1
          fi

          echo "Category ID: $CATEGORY_ID"

          echo "Building JSON payload safely with jq"

          PAYLOAD=$(jq -n \
            --arg title "$RELEASE_TITLE" \
            --arg content "$RELEASE_BODY" \
            --argjson categories "[$CATEGORY_ID]" \
            '{
              title: $title,
              content: $content,
              status: "publish",
              categories: $categories
            }')

          echo "Posting release to Forge Portal"

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$WP_API_URL/release")

          echo "$RESPONSE" | jq .

          STATUS=$(echo "$RESPONSE" | jq -r '.status')

          if [ "$STATUS" != "publish" ]; then
            echo "Forge Portal did not publish the post."
            exit 1
          fi

          LINK=$(echo "$RESPONSE" | jq -r '.link')

          echo "Release published successfully:"
